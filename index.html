<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula Evaluator Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        @media (min-width: 768px) {
            body {
                margin: 40px auto;
                padding: 20px;
            }
            
            .container {
                padding: 30px;
            }
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        @media (min-width: 768px) {
            h1 {
                margin-bottom: 30px;
                font-size: 2rem;
            }
        }
        
        .github-link {
            text-align: center;
            margin-bottom: 15px;
        }
        
        @media (min-width: 768px) {
            .github-link {
                margin-bottom: 20px;
            }
        }
        
        .github-link a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .github-link a:hover {
            text-decoration: underline;
        }
        
        .formula-section {
            margin-bottom: 25px;
        }
        
        .formula-input-container {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .formula-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            min-height: 48px;
            resize: none;
            overflow: hidden;
            line-height: 1.4;
            transition: height 0.2s ease;
        }
        
        .formula-input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        @media (max-width: 767px) {
            .formula-input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px;
            }
        }
        
        .validation-icon {
            width: 24px;
            height: 24px;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 12px;
            flex-shrink: 0;
        }
        
        .valid {
            color: #28a745;
        }
        
        .invalid {
            color: #dc3545;
        }
        
        .formula-help {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .variables-section {
            margin-bottom: 25px;
            display: none;
        }
        
        .variables-section.show {
            display: block;
        }
        
        .variable-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 480px) {
            .variable-input-group {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
        }
        
        .variable-label {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        
        @media (min-width: 480px) {
            .variable-label {
                min-width: 100px;
                font-size: 16px;
            }
        }
        
        .variable-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            min-height: 44px;
        }
        
        .variable-input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .result-section {
            margin-top: 25px;
            display: none;
        }
        
        .result-section.show {
            display: block;
        }
        
        .result-label {
            font-size: 18px;
            font-weight: bold;
            padding: 15px;
            background-color: #e8f4fd;
            border: 2px solid #007bff;
            border-radius: 6px;
            color: #0056b3;
            text-align: center;
        }
        
        .debug-section {
            margin-top: 20px;
            display: none;
        }
        
        .debug-section.show {
            display: block;
        }
        
        .debug-content {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
        }
        
        .debug-content h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .debug-item {
            margin-bottom: 15px;
        }
        
        .debug-item:last-child {
            margin-bottom: 0;
        }
        
        .debug-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        
        .debug-value {
            font-family: 'Courier New', monospace;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 8px 10px;
            font-size: 0.8rem;
            color: #212529;
            word-break: break-all;
        }
        
        .debug-value pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .examples {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        @media (min-width: 768px) {
            .examples {
                padding: 20px;
            }
        }
        
        .examples h3 {
            margin-top: 0;
            color: #555;
            font-size: 1rem;
        }
        
        @media (min-width: 768px) {
            .examples h3 {
                font-size: 1.125rem;
            }
        }
        
        .example-formula {
            font-family: 'Courier New', monospace;
            background-color: #e9ecef;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            margin: 3px;
            font-size: 14px;
            line-height: 1.2;
            word-break: break-all;
            max-width: 100%;
        }
        
        @media (min-width: 480px) {
            .example-formula {
                padding: 4px 8px;
                margin: 2px;
                font-size: 13px;
                word-break: normal;
            }
        }
        
        .example-formula:hover {
            background-color: #dee2e6;
        }
        
        .references {
            margin-top: 25px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        @media (min-width: 768px) {
            .references {
                margin-top: 30px;
                padding: 20px;
            }
        }
        
        .references h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .references ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .references li {
            margin-bottom: 5px;
            line-height: 1.5;
        }
        
        .references a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .references a:hover {
            text-decoration: underline;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßÆ Formula Evaluator Demo</h1>
        
        <div class="github-link">
            <a href="https://github.com/sgagnonboncode/equations-parsing" target="_blank">
                üìÅ View Source Code on GitHub
            </a>
        </div>
        
        <div class="formula-section">
            <div class="formula-input-container">
                <textarea id="formulaInput" 
                       class="formula-input" 
                       placeholder="Enter a formula (e.g., a + b * c, sqrt(a) + b, (x + y) * z)"
                       autocomplete="off"
                       rows="1"></textarea>
                <div id="validationIcon" class="validation-icon"></div>
            </div>
            <div class="formula-help">
                Supported operations: +, -, *, /, ^ (power), sqrt(expression)<br>
                Variables: use letters and underscores (a, b, temp_celsius, etc.)
            </div>
            <div id="errorMessage" class="error-message"></div>
        </div>
        
        <div id="variablesSection" class="variables-section">
            <h3>üìù Variable Values</h3>
            <div id="variableInputs"></div>
        </div>
        
        <div id="resultSection" class="result-section">
            <h3>üìä Result</h3>
            <div id="resultLabel" class="result-label"></div>
        </div>
        
        <div id="debugSection" class="debug-section">
            <div class="debug-content">
                <h4>üîç Debug Information</h4>
                <div class="debug-item">
                    <div class="debug-label">Original Formula:</div>
                    <div id="debugFormula" class="debug-value"></div>
                </div>
                <div class="debug-item">
                    <div class="debug-label">Postfix Notation:</div>
                    <div id="debugPostfix" class="debug-value"></div>
                </div>
                <div class="debug-item">
                    <div class="debug-label">Variable Dictionary:</div>
                    <div id="debugVariables" class="debug-value">
                        <pre></pre>
                    </div>
                </div>
                <div class="debug-item">
                    <div class="debug-label">Abstract Syntax Tree (AST):</div>
                    <div id="debugAST" class="debug-value">
                        <pre></pre>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="examples">
            <h3>üí° Try these examples:</h3>
            <span class="example-formula" onclick="setFormula('a + b')">a + b</span>
            <span class="example-formula" onclick="setFormula('(a + b) * c')">( a + b ) * c</span>
            <span class="example-formula" onclick="setFormula('sqrt(a) + b')">sqrt(a) + b</span>
            <span class="example-formula" onclick="setFormula('a ^ b + c')">a ^ b + c</span>
            <span class="example-formula" onclick="setFormula('(Temperature_fahrenheit - 32) * 5/9')">(Temperature_fahrenheit - 32) * 5/9</span>
            <span class="example-formula" onclick="setFormula('sqrt(sqrt(a + b))')">sqrt(sqrt(a + b))</span>
            <span class="example-formula" onclick="setFormula('alpha * beta_gamma + sqrt(delta)')">alpha * beta_gamma + sqrt(delta)</span>
            <span class="example-formula" onclick="setFormula('sqrt((a + b) ^ 2 + c * d) / (e - f) + sqrt(g)')">sqrt((a + b) ^ 2 + c * d) / (e - f) + sqrt(g)</span>
            
            <h4 style="margin-top: 20px; margin-bottom: 10px; color: #dc3545; font-size: 0.9rem;">‚ùå Invalid examples (test validation):</h4>
            <span class="example-formula" onclick="setFormula('5a + b')" style="border: 1px dashed #dc3545;">5a + b</span>
            <span class="example-formula" onclick="setFormula('a + 3b')" style="border: 1px dashed #dc3545;">a + 3b</span>
            <span class="example-formula" onclick="setFormula('sqrt(a) + b4b4')" style="border: 1px dashed #dc3545;">sqrt(a) + b4b4</span>
            <span class="example-formula" onclick="setFormula('sqrt(a) + b 3')" style="border: 1px dashed #dc3545;">sqrt(a) + b 3</span>
            <span class="example-formula" onclick="setFormula('a +')" style="border: 1px dashed #dc3545;">a +</span>
        </div>
        
        <div class="references">
            <h4>üìö References</h4>
            <ul>
                <li><a href="https://brilliant.org/wiki/shunting-yard-algorithm" target="_blank">Shunting Yard Algorithm - Brilliant.org</a></li>
            </ul>
        </div>
        <div class="footer">
            <p>üöÄ TypeScript Formula Evaluator | Built with Claude Sonnet 4 |
            <a href="https://github.com/sgagnonboncode/equations-parsing" target="_blank">GitHub Repository</a>
            </p>
        </div>
    </div>

    <!-- Include the compiled JavaScript with cache busting -->
    <script>
        // Cache-busting mechanism for browser-build.js
        const script = document.createElement('script');
        script.src = 'browser-build.js?v=' + Date.now();
        document.head.appendChild(script);
    </script>
    
    <script>
        // Get references to DOM elements
        const formulaInput = document.getElementById('formulaInput');
        const validationIcon = document.getElementById('validationIcon');
        const errorMessage = document.getElementById('errorMessage');
        const variablesSection = document.getElementById('variablesSection');
        const variableInputs = document.getElementById('variableInputs');
        const resultSection = document.getElementById('resultSection');
        const resultLabel = document.getElementById('resultLabel');
        const debugSection = document.getElementById('debugSection');
        const debugFormula = document.getElementById('debugFormula');
        const debugPostfix = document.getElementById('debugPostfix');
        const debugVariables = document.getElementById('debugVariables');
        const debugAST = document.getElementById('debugAST');
        
        let currentVariables = [];
        let variableElements = {};
        
        // Function to auto-expand textarea
        function autoExpandTextarea(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.max(48, textarea.scrollHeight);
            textarea.style.height = newHeight + 'px';
        }
        
        // Function to validate formula and update UI
        function validateFormulaUI() {
            const formula = formulaInput.value.trim();
            errorMessage.textContent = '';
            
            // Auto-expand the textarea
            autoExpandTextarea(formulaInput);
            
            if (!formula) {
                validationIcon.textContent = '';
                hideVariablesAndResult();
                return;
            }
            
            try {
                // Validate the formula
                const isValid = window.validateFormula(formula);
                
                if (isValid) {
                    validationIcon.textContent = '‚úì';
                    validationIcon.className = 'validation-icon valid';
                    
                    // Extract variables
                    const variables = window.getFormulaVariables(formula);
                    updateVariableInputs(variables);
                } else {
                    validationIcon.textContent = '‚úó';
                    validationIcon.className = 'validation-icon invalid';
                    errorMessage.textContent = 'Invalid formula syntax';
                    hideVariablesAndResult();
                }
            } catch (error) {
                validationIcon.textContent = '‚úó';
                validationIcon.className = 'validation-icon invalid';
                errorMessage.textContent = 'Error: ' + error.message;
                hideVariablesAndResult();
            }
        }
        
        // Function to update variable inputs
        function updateVariableInputs(variables) {
            currentVariables = variables;
            variableInputs.innerHTML = '';
            variableElements = {};
            
            if (variables.length === 0) {
                // No variables, just show result
                variablesSection.classList.remove('show');
                calculateResult();
            } else {
                // Create input for each variable
                variables.forEach(variable => {
                    const group = document.createElement('div');
                    group.className = 'variable-input-group';
                    
                    const label = document.createElement('label');
                    label.className = 'variable-label';
                    label.textContent = variable + ':';
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.className = 'variable-input';
                    input.placeholder = 'Enter value for ' + variable;
                    input.addEventListener('input', calculateResult);
                    
                    group.appendChild(label);
                    group.appendChild(input);
                    variableInputs.appendChild(group);
                    
                    variableElements[variable] = input;
                });
                
                variablesSection.classList.add('show');
                calculateResult();
            }
        }
        
        // Function to calculate and display result
        function calculateResult() {
            const formula = formulaInput.value.trim();
            
            if (currentVariables.length === 0) {
                // No variables, evaluate directly
                try {
                    const result = window.evaluateFormula(formula, {});
                    resultLabel.textContent = `Result: ${result}`;
                    resultSection.classList.add('show');
                    
                    // Update debug information
                    updateDebugInfo(formula, {});
                } catch (error) {
                    resultSection.classList.remove('show');
                    debugSection.classList.remove('show');
                }
                return;
            }
            
            // Check if all variables have values
            const variables = {};
            let allFilled = true;
            
            currentVariables.forEach(variable => {
                const input = variableElements[variable];
                const value = parseFloat(input.value);
                
                if (isNaN(value) || input.value.trim() === '') {
                    allFilled = false;
                } else {
                    variables[variable] = value;
                }
            });
            
            if (allFilled) {
                try {
                    const result = window.evaluateFormula(formula, variables);
                    resultLabel.textContent = `Result: ${result}`;
                    resultSection.classList.add('show');
                    
                    // Update debug information
                    updateDebugInfo(formula, variables);
                } catch (error) {
                    resultLabel.textContent = `Error: ${error.message}`;
                    resultSection.classList.add('show');
                    debugSection.classList.remove('show');
                }
            } else {
                resultSection.classList.remove('show');
                debugSection.classList.remove('show');
            }
        }
        
        // Function to update debug information
        function updateDebugInfo(formula, variables) {
            try {
                // Update debug elements
                debugFormula.textContent = formula;
                
                // Try to get postfix notation with error handling
                let postfixText = 'N/A';
                try {
                    const postfix = window.getFormulaPostfix(formula);
                    postfixText = Array.isArray(postfix) ? postfix.join(' ') : String(postfix);
                } catch (postfixError) {
                    postfixText = 'Error: ' + postfixError.message;
                }
                
                debugPostfix.textContent = postfixText;
                debugVariables.querySelector('pre').textContent = JSON.stringify(variables, null, 2);
                
                // Try to get AST with error handling
                let astText = 'N/A';
                try {
                    const ast = window.formulaToAST(formula);
                    astText = JSON.stringify(ast, null, 2);
                } catch (astError) {
                    astText = 'Error: ' + astError.message;
                }
                
                debugAST.querySelector('pre').textContent = astText;
                
                debugSection.classList.add('show');
            } catch (error) {
                debugSection.classList.remove('show');
            }
        }
        
        // Function to hide variables and result sections
        function hideVariablesAndResult() {
            variablesSection.classList.remove('show');
            resultSection.classList.remove('show');
            debugSection.classList.remove('show');
        }
        
        // Function to set formula (used by examples)
        function setFormula(formula) {
            formulaInput.value = formula;
            validateFormulaUI();
        }
        
        // Add event listener for formula input
        formulaInput.addEventListener('input', validateFormulaUI);
        formulaInput.addEventListener('paste', function() {
            // Handle paste events with a slight delay to ensure content is pasted
            setTimeout(validateFormulaUI, 10);
        });
        
        // Initialize
        validateFormulaUI();
    </script>
</body>
</html>
